{% extends "meu_app/base.html" %}

{% block title %}Cadastre-se{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="pt-br"> <!-- Define o idioma do documento -->
<head>
    <meta charset="UTF-8"> <!-- Define a codificação do texto -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsividade para dispositivos -->
    <title>Cadastro</title> <!-- Título da página -->
</head>
<body>
<div class="container text-center mt-5">
    <h1>Crie sua Conta</h1>
    <p class="lead mt-3">Já tem uma conta? <a href="{% url 'tela_inicial' %}">Faça login aqui</a>.</p>

    <!-- Exibição de mensagens de feedback -->
    {% if messages %}
    <div class="mt-4">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Formulário de Cadastro -->
    <div class="mt-4">
        <form method="post" action="{% url 'account_signup' %}" class="text-start mx-auto" style="max-width: 400px;">
            {% csrf_token %}

            <!-- Campo: Nome de Usuário (escondido) -->
            <input type="hidden" id="id_username" name="username" value="default_username">

            <!-- Campo: E-mail -->
            <div class="mb-3">
                <label for="id_email" class="form-label">E-mail</label>
                <input type="email" id="id_email" name="email" class="form-control" placeholder="Digite seu e-mail" required>
                <!-- Feedback dinâmico para validação do e-mail -->
                <small id="email_feedback" class="form-text text-danger"></small>
            </div>

            <!-- Campo: Senha -->
            <div class="mb-3">
                <label for="id_password1" class="form-label">Senha</label>
                <input type="password" id="id_password1" name="password1" class="form-control" placeholder="Digite sua senha" required>
            </div>

            <!-- Campo: Confirmar Senha -->
            <div class="mb-3">
                <label for="id_password2" class="form-label">Confirme a Senha</label>
                <input type="password" id="id_password2" name="password2" class="form-control" placeholder="Confirme sua senha" required>
            </div>

            <!-- Botão de Cadastro -->
            <button type="submit" class="btn btn-primary btn-lg w-100">Cadastrar</button>
        </form>
    </div>
</div>

<!-- Script para validação dinâmica do e-mail -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Seleciona os elementos do formulário
        const emailField = document.querySelector("#id_email");
        const emailFeedback = document.querySelector("#email_feedback");
        const form = document.querySelector("form");
        let emailValido = false;  // Variável para controlar se o e-mail é válido

        // Evento "blur" para verificar o e-mail
        emailField.addEventListener("blur", function () {
            const email = emailField.value.trim();  // Remove espaços extras do e-mail

            if (email.length > 3) {  // Só verifica se o e-mail tiver mais de 3 caracteres
                fetch(`/verificar-email/?email=${encodeURIComponent(email)}`)  // Faz a requisição
                    .then(response => response.json())  // Converte a resposta em JSON
                    .then(data => {
                        if (data.existe) {
                            // E-mail já cadastrado
                            emailFeedback.textContent = "Este e-mail já está cadastrado. Por favor, use outro.";
                            emailValido = false;  // Marca como inválido
                        } else {
                            // E-mail disponível
                            emailFeedback.textContent = "";
                            emailValido = true;  // Marca como válido
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao verificar o e-mail:", error);
                        emailFeedback.textContent = "Erro ao verificar o e-mail. Tente novamente mais tarde.";
                        emailValido = false;  // Em caso de erro, marca como inválido
                    });
            } else {
                // Limpa o feedback se o e-mail for muito curto
                emailFeedback.textContent = "";
                emailValido = false;
            }
        });

        // Evento "submit" para bloquear o envio se o e-mail for inválido
        form.addEventListener("submit", function (event) {
            if (!emailValido) {
                event.preventDefault();  // Impede o envio do formulário
                emailFeedback.textContent = "Este e-mail já está cadastrado. Por favor, use outro.";  // Mesma mensagem
            }
        });
    });
</script>
</body>
</html>
{% endblock %}
-