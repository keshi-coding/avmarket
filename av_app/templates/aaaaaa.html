<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat 1x1</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-window {
            width: 300px;
            height: 400px;
            border: 1px solid #ccc;
            margin: 10px;
            position: relative;
            border-radius: 15px;
            background-color: #f4f4f4;
            display: block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chat-log {
            height: 250px;
            overflow-y: scroll;
            padding: 10px;
            background-color: white;
            border-bottom: 1px solid #ccc;
        }

        .chat-header {
            background-color: #0078d4;
            padding: 10px;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .chat-header button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }

        .chat-input {
            width: 85%;
            margin: 10px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
        }

        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .minimized {
            height: 50px;
            width: 300px;
            overflow: hidden;
            background-color: #0078d4;
            color: white;
        }

        .chat-window.minimized {
            height: 50px;
            width: 300px;
            background-color: #0078d4;
        }

        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <h1 class="text-center my-4">Chats 1x1</h1>

    <div id="chat-container" class="d-flex flex-wrap">
        <!-- Janelas de chat serão adicionadas aqui dinamicamente -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Obtém o username do usuário logado
        const user1 = "{{ request.user.username }}";

        // Lista de conversas ativas (substitua com usuários reais)
        const activeChats = [
            { user1: user1, user2: "fulano_a" },
            { user1: user1, user2: "fulano_b" }
            // Adicione mais pares de usuários conforme necessário
        ];

        // Função para criar uma nova janela de chat para cada conversa
        function createChatWindow(user1, user2) {
            const chatWindow = document.createElement('div');
            chatWindow.classList.add('chat-window');
            chatWindow.id = `chat-window-${user1}-${user2}`;

            const chatHeader = document.createElement('div');
            chatHeader.classList.add('chat-header');
            chatHeader.innerHTML = `Conversa entre ${user1} e ${user2}`;

            // Botões de minimizar e fechar
            const minimizeButton = document.createElement('button');
            minimizeButton.textContent = '−';
            minimizeButton.classList.add('btn', 'btn-light', 'btn-sm');
            minimizeButton.onclick = function() {
                chatWindow.classList.toggle('minimized');
            };

            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.classList.add('btn', 'btn-light', 'btn-sm');
            closeButton.onclick = function() {
                chatWindow.style.display = 'none'; // Fecha a janela
            };

            chatHeader.appendChild(minimizeButton);
            chatHeader.appendChild(closeButton);
            chatWindow.appendChild(chatHeader);

            const chatLog = document.createElement('div');
            chatLog.classList.add('chat-log');
            chatLog.id = `chat-log-${user1}-${user2}`;
            chatWindow.appendChild(chatLog);

            const messageInput = document.createElement('input');
            messageInput.classList.add('chat-input', 'form-control');
            messageInput.id = `message-input-${user1}-${user2}`;
            messageInput.placeholder = "Digite sua mensagem...";
            chatWindow.appendChild(messageInput);

            const sendButton = document.createElement('button');
            sendButton.classList.add('btn', 'btn-primary', 'w-100');
            sendButton.textContent = 'Enviar';
            sendButton.onclick = function() {
                const message = messageInput.value;
                sendMessage(user1, user2, message);
                messageInput.value = '';  // Limpar o campo de entrada
            };

            // Função para enviar a mensagem
            function sendMessage(user1, user2, message) {
                // Enviar via WebSocket
                const chatSocket = new WebSocket(`ws://localhost:8000/ws/chat/${user1}/${user2}/`);
                chatSocket.send(JSON.stringify({ 'message': message }));
            }

            chatWindow.appendChild(sendButton);

            document.getElementById('chat-container').appendChild(chatWindow);
        }

        // Criar uma janela de chat para cada conversa ativa
        activeChats.forEach(chat => {
            const { user1, user2 } = chat;
            createChatWindow(user1, user2);
        });


        // Função para adicionar mensagens ao chat-log
        function addMessageToChatLog(user1, user2, message) {
            const chatLog = document.getElementById(`chat-log-${user1}-${user2}`);
            if (chatLog) {
                const messageElement = document.createElement('div');
                messageElement.textContent = message;
                chatLog.appendChild(messageElement);
                chatLog.scrollTop = chatLog.scrollHeight; // Rolagem automática para a última mensagem
            }
        }

        // Modificar a função que recebe mensagens do WebSocket
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            addMessageToChatLog(user1, user2, data.message);
        };


    </script>
</body>
</html>
