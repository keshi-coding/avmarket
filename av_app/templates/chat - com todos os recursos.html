<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat 1x1</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-window {
            width: 300px;
            height: 400px;
            border: 1px solid #ccc;
            margin: 10px;
            position: relative;
            border-radius: 15px;
            background-color: #f4f4f4;
            display: block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chat-log {
            height: 250px;
            overflow-y: scroll;
            padding: 10px;
            background-color: white;
            border-bottom: 1px solid #ccc;
        }

        .chat-header {
            background-color: #0078d4;
            padding: 10px;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .chat-header button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }

        .chat-input {
            width: 85%;
            margin: 10px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
        }

        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .minimized {
            height: 50px;
            width: 300px;
            overflow: hidden;
            background-color: #0078d4;
            color: white;
        }

        .chat-window.minimized {
            height: 50px;
            width: 300px;
            background-color: #0078d4;
        }

        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <h1 class="text-center my-4">Chats 1x1</h1>

    <div id="chat-container" class="d-flex flex-wrap">
        <!-- Janelas de chat ser√£o adicionadas aqui dinamicamente -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Lista de conversas ativas (substitua com usu√°rios reais)
        const activeChats = [
            { user1: "user1", user2: "user2" },
            { user1: "user1", user2: "user3" },
            // Adicione mais pares de usu√°rios conforme necess√°rio
        ];

        // Fun√ß√£o para criar uma nova janela de chat para cada conversa
        function createChatWindow(user1, user2) {
            const chatWindow = document.createElement('div');
            chatWindow.classList.add('chat-window');
            chatWindow.id = `chat-window-${user1}-${user2}`;

            const chatHeader = document.createElement('div');
            chatHeader.classList.add('chat-header');
            chatHeader.innerHTML = `Conversa entre ${user1} e ${user2}`;

            // Bot√µes de minimizar e fechar
            const minimizeButton = document.createElement('button');
            minimizeButton.textContent = '‚àí';
            minimizeButton.classList.add('btn', 'btn-light', 'btn-sm');
            minimizeButton.onclick = function() {
                chatWindow.classList.toggle('minimized');
            };

            const closeButton = document.createElement('button');
            closeButton.textContent = '√ó';
            closeButton.classList.add('btn', 'btn-light', 'btn-sm');
            closeButton.onclick = function() {
                chatWindow.style.display = 'none'; // Fecha a janela
            };

            // √çcone de imagem para enviar
            const imageButton = document.createElement('button');
            imageButton.classList.add('btn', 'btn-light', 'btn-sm');
            imageButton.innerHTML = 'üì∑';  // √çcone de imagem
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            imageButton.onclick = function() {
                fileInput.click();  // Aciona o seletor de arquivos quando o bot√£o for clicado
            };

            // Adiciona o bot√£o de imagem √† barra de t√≠tulo
            chatHeader.appendChild(imageButton);
            chatHeader.appendChild(minimizeButton);
            chatHeader.appendChild(closeButton);
            chatWindow.appendChild(chatHeader);

            const chatLog = document.createElement('div');
            chatLog.classList.add('chat-log');
            chatLog.id = `chat-log-${user1}-${user2}`;
            chatWindow.appendChild(chatLog);

            // Permitir arrastar e soltar uma imagem na √°rea de chat
            chatLog.ondragover = function(e) {
                e.preventDefault(); // Necess√°rio para permitir o "drop"
                chatLog.style.backgroundColor = "#f0f0f0"; // Alterar cor ao arrastar uma imagem sobre a √°rea
            };

            chatLog.ondragleave = function(e) {
                chatLog.style.backgroundColor = "white"; // Voltar √† cor original quando o arraste sair da √°rea
            };

            chatLog.ondrop = function(e) {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const imagePreview = document.createElement('img');
                        imagePreview.classList.add('image-preview');
                        imagePreview.src = event.target.result;
                        chatLog.appendChild(imagePreview);
                        sendMessage(user1, user2, event.target.result); // Enviar a imagem
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Criar o WebSocket aqui, no in√≠cio da fun√ß√£o
            const chatSocket = new WebSocket(`ws://localhost:8000/ws/chat/${user1}/${user2}/`);

            const messageInput = document.createElement('input');
            messageInput.classList.add('chat-input', 'form-control');
            messageInput.id = `message-input-${user1}-${user2}`;
            messageInput.placeholder = "Digite sua mensagem...";
            chatWindow.appendChild(messageInput);

            const sendButton = document.createElement('button');
            sendButton.classList.add('btn', 'btn-primary', 'w-100');
            sendButton.textContent = 'Enviar';
            sendButton.onclick = function() {
                const message = messageInput.value;
                sendMessage(user1, user2, message);
                messageInput.value = '';  // Limpar o campo de entrada
            };

            // Fun√ß√£o para enviar a mensagem
            function sendMessage(user1, user2, message) {
                chatSocket.send(JSON.stringify({ 'message': message }));
            }


            // Dentro da fun√ß√£o createChatWindow(), logo ap√≥s o campo de entrada (messageInput):

            messageInput.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imagePreview = document.createElement('img');
                            imagePreview.classList.add('image-preview');
                            imagePreview.src = event.target.result;
                            document.getElementById(`chat-log-${user1}-${user2}`).appendChild(imagePreview);
                            sendMessage(user1, user2, event.target.result); // Enviar a imagem
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });




            chatWindow.appendChild(sendButton);

            document.getElementById('chat-container').appendChild(chatWindow);


            // Dentro da fun√ß√£o createChatWindow():

            // √çcone de emoji
            const emojiButton = document.createElement('button');
            emojiButton.classList.add('btn', 'btn-light', 'btn-sm');
            emojiButton.innerHTML = 'üòä';  // √çcone de emoji

            // Lista de emojis
            const emojiList = document.createElement('div');
            emojiList.classList.add('emoji-list');
            emojiList.style.display = 'none';  // Come√ßa escondido
            emojiList.innerHTML = `
                <span>üòÄ</span><span>üòÑ</span><span>üòä</span><span>üòé</span><span>üòç</span>
                <span>üòÇ</span><span>üò¢</span><span>üò°</span><span>ü§î</span><span>üò¥</span>
            `;

            // Colocar a lista de emojis logo abaixo do bot√£o de emoji
            chatWindow.appendChild(emojiButton);
            chatWindow.appendChild(emojiList);

            // Mostrar/ocultar lista de emojis ao clicar no √≠cone
            emojiButton.onclick = function() {
                emojiList.style.display = emojiList.style.display === 'none' ? 'block' : 'none';
            };

            // Inserir emoji no campo de mensagem ao clicar no emoji
            emojiList.onclick = function(e) {
                if (e.target.tagName === 'SPAN') {
                    messageInput.value += e.target.textContent;  // Adiciona o emoji no campo de mensagem
                    emojiList.style.display = 'none';  // Fecha a lista de emojis ap√≥s selecionar
                }
            };





            let mediaRecorder;
            let audioChunks = [];

            // Dentro da fun√ß√£o createChatWindow():

            // √çcone de microfone para gravar √°udio
            const audioButton = document.createElement('button');
            audioButton.classList.add('btn', 'btn-light', 'btn-sm');
            audioButton.innerHTML = 'üé§';  // √çcone de microfone

            // Bot√£o para come√ßar/terminar a grava√ß√£o
            let isRecording = false;
            audioButton.onclick = function() {
                if (isRecording) {
                    // Parar a grava√ß√£o e enviar o √°udio
                    mediaRecorder.stop();
                    isRecording = false;
                    audioButton.innerHTML = 'üé§'; // Resetando o √≠cone do microfone
                } else {
                    // Iniciar a grava√ß√£o
                    startRecording();
                    isRecording = true;
                    audioButton.innerHTML = '‚èπÔ∏è'; // √çcone de parada de grava√ß√£o
                }
            };

            // Fun√ß√£o para come√ßar a grava√ß√£o
            function startRecording() {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                        mediaRecorder.start();

                        // Capturar os peda√ßos de √°udio enquanto grava
                        mediaRecorder.ondataavailable = function(event) {
                            audioChunks.push(event.data);
                        };

                        // Quando a grava√ß√£o terminar, gerar o √°udio e enviar
                        mediaRecorder.onstop = function() {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const audioPreview = document.createElement('audio');
                            audioPreview.classList.add('image-preview');
                            audioPreview.src = audioUrl;
                            audioPreview.controls = true;  // Adiciona os controles de reprodu√ß√£o
                            audioPreview.style.width = "100%";  // Garantir que o √°udio seja responsivo
                            document.getElementById(`chat-log-${user1}-${user2}`).appendChild(audioPreview);

                            // Enviar o √°udio gravado
                            sendMessage(user1, user2, audioUrl);  // Enviar a URL do √°udio
                        };
                    })
                    .catch(err => {
                        console.error("Erro ao acessar o microfone: ", err);
                    });
            }

            chatHeader.appendChild(audioButton); // Adiciona o bot√£o de microfone

            // Permitir arrastar e soltar v√≠deos na √°rea de chat
            chatLog.ondragover = function(e) {
                e.preventDefault(); // Necess√°rio para permitir o "drop"
                chatLog.style.backgroundColor = "#f0f0f0"; // Alterar cor ao arrastar um arquivo sobre a √°rea
            };

            chatLog.ondragleave = function(e) {
                chatLog.style.backgroundColor = "white"; // Voltar √† cor original quando o arraste sair da √°rea
            };

            chatLog.ondrop = function(e) {
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const videoPreview = document.createElement('video');
                        videoPreview.classList.add('image-preview');
                        videoPreview.src = event.target.result;
                        videoPreview.controls = true;  // Adiciona os controles de reprodu√ß√£o
                        videoPreview.style.width = "100%";  // Tornar o v√≠deo responsivo
                        chatLog.appendChild(videoPreview);
                        sendMessage(user1, user2, event.target.result); // Enviar o v√≠deo
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Permitir colar v√≠deos diretamente
            messageInput.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (const item of items) {
                    if (item.type.startsWith('video/')) {
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const videoPreview = document.createElement('video');
                            videoPreview.classList.add('image-preview');
                            videoPreview.src = event.target.result;
                            videoPreview.controls = true;  // Adiciona os controles de reprodu√ß√£o
                            videoPreview.style.width = "100%";  // Tornar o v√≠deo responsivo
                            document.getElementById(`chat-log-${user1}-${user2}`).appendChild(videoPreview);
                            sendMessage(user1, user2, event.target.result); // Enviar o v√≠deo
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });


            // Fun√ß√£o para mostrar a imagem antes de enviar
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imagePreview = document.createElement('img');
                    imagePreview.classList.add('image-preview');
                    imagePreview.src = event.target.result;
                    document.getElementById(`chat-log-${user1}-${user2}`).appendChild(imagePreview);
                    sendMessage(user1, user2, event.target.result);  // Envia a imagem
                };
                reader.readAsDataURL(file);
            };

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const message = data['message'];
                const chatLog = document.getElementById(`chat-log-${user1}-${user2}`);
                chatLog.innerHTML += `<p>${message}</p>`;
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };
        }

        // Criar uma janela de chat para cada conversa ativa
        activeChats.forEach(chat => {
            const { user1, user2 } = chat;
            createChatWindow(user1, user2);
        });
    </script>
</body>
</html>
